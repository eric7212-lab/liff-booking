<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<title>LINE 用車預約</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
<pre id="status">初始化中…</pre>

<script>
(async () => {
  try {
    await liff.init({ liffId: "2008700969-bNDOgS7g" });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    const lineUserId = profile.userId;
    const lineName = profile.displayName;

    document.getElementById("status").innerText =
      "LINE UID: " + lineUserId + "\n建立 Ragic 資料中…";

    const res = await fetch(
      "https://ap11.ragic.com/HydexTech/customer-orders/1",
      {
        method: "POST",
        headers: {
          // ⚠️ 注意這一行
          "Authorization": "Basic Wk53UWprQmRhV1JEODNUaDF2eVhGSzNqODFvRVdBcHFaZUxqb1RiRlV5S01qN1hDMGNtUGlaUHFNcHVEMWIwTg==",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          1001858: lineUserId,
          1001859: lineName
        })
      }
    );

    const text = await res.text();
    document.getElementById("status").innerText +=
      "\nHTTP 狀態碼: " + res.status +
      "\n回傳內容:\n" + text;

    if (!res.ok) throw new Error("API 失敗");

    const result = JSON.parse(text);

    if (!result?.data?._ragicId)
      throw new Error("未取得 ragicId");

    window.location.href =
      "https://ap11.ragic.com/HydexTech/customer-orders/1/" +
      result.data._ragicId +
      "?edit";

  } catch (err) {
    document.getElementById("status").innerText +=
      "\n錯誤：" + err.message;
  }
})();
</script>
</body>
</html>
